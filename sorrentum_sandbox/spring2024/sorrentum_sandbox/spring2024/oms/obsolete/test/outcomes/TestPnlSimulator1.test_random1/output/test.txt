df=
                          price         ask         bid
2021-09-12 09:30:00  100.496714  101.509545  100.483217
2021-09-12 09:31:00  100.358450  100.672697   99.300739
2021-09-12 09:32:00  101.006138  101.914162  100.183593
2021-09-12 09:33:00  102.529168  103.941472  101.308325
2021-09-12 09:34:00  102.295015  103.760664  102.086151
2021-09-12 09:35:00  102.060878  102.286654  100.101208
2021-09-12 09:36:00  103.640091  103.707619  102.311905
2021-09-12 09:37:00  104.407525  105.832274  104.210664
2021-09-12 09:38:00  103.938051  104.482434  103.199584
2021-09-12 09:39:00  104.480611  104.591534  104.309243
2021-09-12 09:40:00  104.017193  105.168187  103.901545
2021-09-12 09:41:00  103.551464  103.927162  103.250360
2021-09-12 09:42:00  103.793426  104.394065  102.314904
2021-09-12 09:43:00  101.880146  102.171839  101.160301
2021-09-12 09:44:00  100.155228  100.756934   99.694589
2021-09-12 09:45:00   99.592940  101.445219   98.535818
df_5mins=
                          price         ask         bid     ret_0  preds
2021-09-12 09:30:00  100.496714  101.509545  100.483217       NaN   -1.0
2021-09-12 09:35:00  102.060878  102.286654  100.101208  0.015564    1.0
2021-09-12 09:40:00  104.017193  105.168187  103.901545  0.019168    0.0
2021-09-12 09:45:00   99.592940  101.445219   98.535818 -0.042534    0.0
# tot_ret=-0.06088669245145979
After pnl simulation level 1: df_5mins=
                          price         ask         bid     ret_0  preds  sim1.num_shares  sim1.diff  sim1.wealth  sim1.pnl
2021-09-12 09:30:00  100.496714  101.509545  100.483217       NaN   -1.0         9.798074 -19.168123   980.831877 -0.019168
2021-09-12 09:35:00  102.060878  102.286654  100.101208  0.015564    1.0         9.429517 -41.718569   939.113308 -0.042534
2021-09-12 09:40:00  104.017193  105.168187  103.901545  0.019168    0.0              NaN        NaN          NaN  0.000000
2021-09-12 09:45:00   99.592940  101.445219   98.535818 -0.042534    0.0              NaN        NaN          NaN  0.000000
After pnl lag computation: df_5mins=
                          price         ask         bid     ret_0  preds  sim1.num_shares  sim1.diff  sim1.wealth  sim1.pnl   lag.pnl
2021-09-12 09:30:00  100.496714  101.509545  100.483217       NaN   -1.0         9.798074 -19.168123   980.831877 -0.019168 -0.019168
2021-09-12 09:35:00  102.060878  102.286654  100.101208  0.015564    1.0         9.429517 -41.718569   939.113308 -0.042534 -0.042534
2021-09-12 09:40:00  104.017193  105.168187  103.901545  0.019168    0.0              NaN        NaN          NaN  0.000000       NaN
2021-09-12 09:45:00   99.592940  101.445219   98.535818 -0.042534    0.0              NaN        NaN          NaN  0.000000       NaN
# tot_ret_lag=-0.06088669245145972
After pnl simulation level 2: df_5mins=
                          price         ask         bid     ret_0  preds  sim1.num_shares  sim1.diff  sim1.wealth  sim1.pnl   lag.pnl  sim2.target_n_shares  sim2.cash  sim2.holdings  sim2.wealth  sim2.diff_n_shares  sim2.filled_n_shares  sim2.cash+1  sim2.holdings+1  sim2.pnl
2021-09-12 09:30:00  100.496714  101.509545  100.483217       NaN   -1.0         9.798074 -19.168123   980.831877 -0.019168 -0.019168             -9.798074     1000.0       0.000000  1000.000000           -9.798074             -9.798074  2000.000000        -9.798074       NaN
2021-09-12 09:35:00  102.060878  102.286654  100.101208  0.015564    1.0         9.429517 -41.718569   939.113308 -0.042534 -0.042534              9.429517     2000.0      -9.798074  1000.000000           19.227590             19.227590     0.000000         9.429517  0.000000
2021-09-12 09:40:00  104.017193  105.168187  103.901545  0.019168    0.0              NaN        NaN          NaN  0.000000       NaN              0.000000        0.0       9.429517   980.831877           -9.429517             -9.429517   939.113308         0.000000 -0.019168
2021-09-12 09:45:00   99.592940  101.445219   98.535818 -0.042534    0.0              NaN        NaN          NaN  0.000000       NaN                   NaN        NaN            NaN   939.113308                 NaN                   NaN          NaN              NaN -0.042534
