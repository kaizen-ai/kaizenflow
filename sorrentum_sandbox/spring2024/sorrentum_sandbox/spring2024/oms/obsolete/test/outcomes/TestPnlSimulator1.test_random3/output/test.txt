df=
                          price         ask         bid
2021-09-12 09:30:00   99.249385   99.894762   97.611097
2021-09-12 09:31:00  100.565743  101.445081   99.137053
2021-09-12 09:32:00  101.811883  102.130265  101.043325
2021-09-12 09:33:00  100.206967  100.934325  100.034362
2021-09-12 09:34:00   98.738823   98.804405   98.356510
2021-09-12 09:35:00   97.023753   97.474805   96.515507
2021-09-12 09:36:00   98.882536   99.736067   97.908700
2021-09-12 09:37:00   98.970124  101.505807   97.261786
2021-09-12 09:38:00   98.917802   99.305286   98.775054
2021-09-12 09:39:00   99.473274   99.494349   98.280918
2021-09-12 09:40:00   98.509870   98.826092   98.089455
2021-09-12 09:41:00   98.329549   98.959364   98.118986
2021-09-12 09:42:00   97.146140   99.125821   96.352525
2021-09-12 09:43:00   97.751585   98.028270   97.257114
2021-09-12 09:44:00   96.799935   98.036379   95.875812
2021-09-12 09:45:00   97.160791   97.734126   96.035480
2021-09-12 09:46:00   98.221401   98.539887   97.123418
2021-09-12 09:47:00   98.104249   98.182969   97.446025
2021-09-12 09:48:00   98.929914  100.407107   98.481382
2021-09-12 09:49:00   97.720100   98.848229   96.883662
2021-09-12 09:50:00   96.529597   97.614306   96.091275
2021-09-12 09:51:00   96.749469   98.600595   96.200055
2021-09-12 09:52:00   96.536549   97.869688   94.209054
2021-09-12 09:53:00   95.125050   97.365964   94.929923
2021-09-12 09:54:00   94.642069   95.425138   92.873756
2021-09-12 09:55:00   95.843831   96.087375   95.027100
2021-09-12 09:56:00   95.138028   96.148081   94.742687
2021-09-12 09:57:00   95.163210   95.880868   94.866667
2021-09-12 09:58:00   94.772082   97.672930   94.528107
2021-09-12 09:59:00   94.965221   95.351157   94.634584
2021-09-12 10:00:00   95.314512   95.354332   94.124704
2021-09-12 10:01:00   95.905700   96.013211   95.463516
2021-09-12 10:02:00   96.426110   97.710646   96.423235
2021-09-12 10:03:00   97.251332   97.593312   95.955570
2021-09-12 10:04:00   97.677536   99.509348   96.813588
2021-09-12 10:05:00   97.873176   99.322519   97.271151
2021-09-12 10:06:00   97.359064   97.887185   96.189288
2021-09-12 10:07:00   94.285375   95.196018   93.693023
2021-09-12 10:08:00   93.890216   94.541418   93.729649
2021-09-12 10:09:00   93.094817   93.111165   92.347381
2021-09-12 10:10:00   92.391615   92.528402   91.351452
2021-09-12 10:11:00   90.654222   91.431877   90.610920
2021-09-12 10:12:00   91.405031   92.201860   91.333703
2021-09-12 10:13:00   89.541077   89.579389   89.463605
2021-09-12 10:14:00   89.959588   90.019658   89.869504
2021-09-12 10:15:00   89.724255   89.731743   88.892629
2021-09-12 10:16:00   90.156362   90.541147   89.847646
2021-09-12 10:17:00   91.026654   92.053373   88.692585
2021-09-12 10:18:00   93.035276   94.115178   92.673010
2021-09-12 10:19:00   94.407047   96.981458   94.341468
2021-09-12 10:20:00   95.465645   95.770243   95.362905
2021-09-12 10:21:00   96.910982   98.803460   96.189296
2021-09-12 10:22:00   96.959806   97.976055   95.601416
2021-09-12 10:23:00   97.050135   97.093875   96.536935
2021-09-12 10:24:00   96.569878   97.727454   95.830680
2021-09-12 10:25:00   96.870541   97.266188   95.185577
2021-09-12 10:26:00   97.983521   98.653643   97.667665
2021-09-12 10:27:00   97.964206   98.283991   97.166137
2021-09-12 10:28:00   97.963398   98.258979   97.680652
2021-09-12 10:29:00   97.324868   97.732238   96.934454
2021-09-12 10:30:00   98.919551   99.364340   97.394688
2021-09-12 10:31:00   98.938164  100.329041   97.796169
2021-09-12 10:32:00   99.499573  101.175184   99.080796
2021-09-12 10:33:00   99.301096  100.681723   98.855776
2021-09-12 10:34:00   99.764304  101.041061   98.723265
2021-09-12 10:35:00   97.945210   98.721270   96.748356
2021-09-12 10:36:00   98.078134   98.671398   97.814301
2021-09-12 10:37:00   97.461055   98.216503   95.532092
2021-09-12 10:38:00   98.769234   99.130075   97.063109
2021-09-12 10:39:00   99.545072  100.038238   98.829392
2021-09-12 10:40:00   99.264902   99.740901   99.195169
2021-09-12 10:41:00   98.540964  100.745122   98.114852
2021-09-12 10:42:00   97.597654   97.964321   97.395207
2021-09-12 10:43:00   98.159340   98.374052   97.255504
2021-09-12 10:44:00   97.466548   98.172887   94.806629
2021-09-12 10:45:00   99.168307  100.072207   98.473509
2021-09-12 10:46:00   98.116585  100.912052   97.986913
2021-09-12 10:47:00   97.455433   98.972241   96.374419
2021-09-12 10:48:00   96.444533   97.015914   96.044469
2021-09-12 10:49:00   94.985653   95.544878   93.428085
2021-09-12 10:50:00   95.376206   97.474977   94.145798
2021-09-12 10:51:00   94.565762   94.892065   93.366461
2021-09-12 10:52:00   95.723434   95.725530   94.905195
2021-09-12 10:53:00   95.755197   96.137962   95.475758
2021-09-12 10:54:00   93.858268   94.510182   93.200321
2021-09-12 10:55:00   92.993317   94.079530   92.378577
2021-09-12 10:56:00   92.936120   93.879993   91.950943
2021-09-12 10:57:00   94.167138   95.363149   93.885512
2021-09-12 10:58:00   93.633586   94.048992   92.849449
2021-09-12 10:59:00   93.297612   95.154030   93.132456
2021-09-12 11:00:00   91.741888   92.242182   91.495684
2021-09-12 11:01:00   92.960527   94.746248   92.461194
2021-09-12 11:02:00   90.702884   92.340211   90.262798
2021-09-12 11:03:00   90.923902   92.002711   90.823188
2021-09-12 11:04:00   90.868730   91.188214   88.363221
2021-09-12 11:05:00   91.149915   92.151698   90.206595
2021-09-12 11:06:00   91.748561   92.204855   91.453216
2021-09-12 11:07:00   92.775735   93.586178   92.601656
2021-09-12 11:08:00   92.782677   93.416624   91.648593
2021-09-12 11:09:00   91.029367   91.289343   89.540259
2021-09-12 11:10:00   92.578598   93.775690   92.411338
df_5mins=
                         price         ask        bid     ret_0  preds
2021-09-12 09:30:00  99.249385   99.894762  97.611097       NaN   -1.0
2021-09-12 09:35:00  97.023753   97.474805  96.515507 -0.022425    1.0
2021-09-12 09:40:00  98.509870   98.826092  98.089455  0.015317    1.0
2021-09-12 09:45:00  97.160791   97.734126  96.035480 -0.013695    1.0
2021-09-12 09:50:00  96.529597   97.614306  96.091275 -0.006496   -1.0
2021-09-12 09:55:00  95.843831   96.087375  95.027100 -0.007104   -1.0
2021-09-12 10:00:00  95.314512   95.354332  94.124704 -0.005523   -1.0
2021-09-12 10:05:00  97.873176   99.322519  97.271151  0.026844    1.0
2021-09-12 10:10:00  92.391615   92.528402  91.351452 -0.056007    1.0
2021-09-12 10:15:00  89.724255   89.731743  88.892629 -0.028870    1.0
2021-09-12 10:20:00  95.465645   95.770243  95.362905  0.063989   -1.0
2021-09-12 10:25:00  96.870541   97.266188  95.185577  0.014716    1.0
2021-09-12 10:30:00  98.919551   99.364340  97.394688  0.021152    1.0
2021-09-12 10:35:00  97.945210   98.721270  96.748356 -0.009850   -1.0
2021-09-12 10:40:00  99.264902   99.740901  99.195169  0.013474   -1.0
2021-09-12 10:45:00  99.168307  100.072207  98.473509 -0.000973   -1.0
2021-09-12 10:50:00  95.376206   97.474977  94.145798 -0.038239   -1.0
2021-09-12 10:55:00  92.993317   94.079530  92.378577 -0.024984    1.0
2021-09-12 11:00:00  91.741888   92.242182  91.495684 -0.013457   -1.0
2021-09-12 11:05:00  91.149915   92.151698  90.206595 -0.006453    0.0
2021-09-12 11:10:00  92.578598   93.775690  92.411338  0.015674    0.0
# tot_ret=0.07641451313953075
After pnl simulation level 1: df_5mins=
                         price         ask        bid     ret_0  preds  sim1.num_shares  sim1.diff  sim1.wealth  sim1.pnl
2021-09-12 09:30:00  99.249385   99.894762  97.611097       NaN   -1.0        10.306754 -15.317047   984.682953 -0.015317
2021-09-12 09:35:00  97.023753   97.474805  96.515507 -0.022425    1.0         9.995780 -13.485098   971.197854 -0.013695
2021-09-12 09:40:00  98.509870   98.826092  98.089455  0.015317    1.0         9.995780  -6.309279   964.888576 -0.006496
2021-09-12 09:45:00  97.160791   97.734126  96.035480 -0.013695    1.0         9.995780  -6.854760   958.033816 -0.007104
2021-09-12 09:50:00  96.529597   97.614306  96.091275 -0.006496   -1.0         9.995780   5.290964   963.324780  0.005523
2021-09-12 09:55:00  95.843831   96.087375  95.027100 -0.007104   -1.0        10.106801 -25.859909   937.464871 -0.026844
2021-09-12 10:00:00  95.314512   95.354332  94.124704 -0.005523   -1.0         9.578364  52.504382   989.969253  0.056007
2021-09-12 10:05:00  97.873176   99.322519  97.271151  0.026844    1.0        10.714925 -28.580568   961.388686 -0.028870
2021-09-12 10:10:00  92.391615   92.528402  91.351452 -0.056007    1.0        10.714925  61.518566  1022.907252  0.063989
2021-09-12 10:15:00  89.724255   89.731743  88.892629 -0.028870    1.0        10.714925  15.053359  1037.960611  0.014716
2021-09-12 10:20:00  95.465645   95.770243  95.362905  0.063989   -1.0        10.714925 -21.954992  1016.005618 -0.021152
2021-09-12 10:25:00  96.870541   97.266188  95.185577  0.014716    1.0        10.271029 -10.007491  1005.998127 -0.009850
2021-09-12 10:30:00  98.919551   99.364340  97.394688  0.021152    1.0        10.271029  13.554595  1019.552722  0.013474
2021-09-12 10:35:00  97.945210   98.721270  96.748356 -0.009850   -1.0        10.271029   0.992126  1020.544848  0.000973
2021-09-12 10:40:00  99.264902   99.740901  99.195169  0.013474   -1.0        10.291038  39.024659  1059.569507  0.038239
2021-09-12 10:45:00  99.168307  100.072207  98.473509 -0.000973   -1.0        11.109369  26.472388  1086.041895  0.024984
2021-09-12 10:50:00  95.376206   97.474977  94.145798 -0.038239   -1.0        11.678709  14.615079  1100.656973  0.013457
2021-09-12 10:55:00  92.993317   94.079530  92.378577 -0.024984    1.0        11.997322  -7.102094  1093.554879 -0.006453
2021-09-12 11:00:00  91.741888   92.242182  91.495684 -0.013457   -1.0        11.997322 -17.140366  1076.414513 -0.015674
2021-09-12 11:05:00  91.149915   92.151698  90.206595 -0.006453    0.0              NaN        NaN          NaN  0.000000
2021-09-12 11:10:00  92.578598   93.775690  92.411338  0.015674    0.0              NaN        NaN          NaN  0.000000
After pnl lag computation: df_5mins=
                         price         ask        bid     ret_0  preds  sim1.num_shares  sim1.diff  sim1.wealth  sim1.pnl   lag.pnl
2021-09-12 09:30:00  99.249385   99.894762  97.611097       NaN   -1.0        10.306754 -15.317047   984.682953 -0.015317 -0.015317
2021-09-12 09:35:00  97.023753   97.474805  96.515507 -0.022425    1.0         9.995780 -13.485098   971.197854 -0.013695 -0.013695
2021-09-12 09:40:00  98.509870   98.826092  98.089455  0.015317    1.0         9.995780  -6.309279   964.888576 -0.006496 -0.006496
2021-09-12 09:45:00  97.160791   97.734126  96.035480 -0.013695    1.0         9.995780  -6.854760   958.033816 -0.007104 -0.007104
2021-09-12 09:50:00  96.529597   97.614306  96.091275 -0.006496   -1.0         9.995780   5.290964   963.324780  0.005523  0.005523
2021-09-12 09:55:00  95.843831   96.087375  95.027100 -0.007104   -1.0        10.106801 -25.859909   937.464871 -0.026844 -0.026844
2021-09-12 10:00:00  95.314512   95.354332  94.124704 -0.005523   -1.0         9.578364  52.504382   989.969253  0.056007  0.056007
2021-09-12 10:05:00  97.873176   99.322519  97.271151  0.026844    1.0        10.714925 -28.580568   961.388686 -0.028870 -0.028870
2021-09-12 10:10:00  92.391615   92.528402  91.351452 -0.056007    1.0        10.714925  61.518566  1022.907252  0.063989  0.063989
2021-09-12 10:15:00  89.724255   89.731743  88.892629 -0.028870    1.0        10.714925  15.053359  1037.960611  0.014716  0.014716
2021-09-12 10:20:00  95.465645   95.770243  95.362905  0.063989   -1.0        10.714925 -21.954992  1016.005618 -0.021152 -0.021152
2021-09-12 10:25:00  96.870541   97.266188  95.185577  0.014716    1.0        10.271029 -10.007491  1005.998127 -0.009850 -0.009850
2021-09-12 10:30:00  98.919551   99.364340  97.394688  0.021152    1.0        10.271029  13.554595  1019.552722  0.013474  0.013474
2021-09-12 10:35:00  97.945210   98.721270  96.748356 -0.009850   -1.0        10.271029   0.992126  1020.544848  0.000973  0.000973
2021-09-12 10:40:00  99.264902   99.740901  99.195169  0.013474   -1.0        10.291038  39.024659  1059.569507  0.038239  0.038239
2021-09-12 10:45:00  99.168307  100.072207  98.473509 -0.000973   -1.0        11.109369  26.472388  1086.041895  0.024984  0.024984
2021-09-12 10:50:00  95.376206   97.474977  94.145798 -0.038239   -1.0        11.678709  14.615079  1100.656973  0.013457  0.013457
2021-09-12 10:55:00  92.993317   94.079530  92.378577 -0.024984    1.0        11.997322  -7.102094  1093.554879 -0.006453 -0.006453
2021-09-12 11:00:00  91.741888   92.242182  91.495684 -0.013457   -1.0        11.997322 -17.140366  1076.414513 -0.015674 -0.015674
2021-09-12 11:05:00  91.149915   92.151698  90.206595 -0.006453    0.0              NaN        NaN          NaN  0.000000       NaN
2021-09-12 11:10:00  92.578598   93.775690  92.411338  0.015674    0.0              NaN        NaN          NaN  0.000000       NaN
# tot_ret_lag=0.0764145131395304
After pnl simulation level 2: df_5mins=
                         price         ask        bid     ret_0  preds  sim1.num_shares  sim1.diff  sim1.wealth  sim1.pnl   lag.pnl  sim2.target_n_shares     sim2.cash  sim2.holdings  sim2.wealth  sim2.diff_n_shares  sim2.filled_n_shares   sim2.cash+1  sim2.holdings+1  sim2.pnl
2021-09-12 09:30:00  99.249385   99.894762  97.611097       NaN   -1.0        10.306754 -15.317047   984.682953 -0.015317 -0.015317            -10.306754  1.000000e+03       0.000000  1000.000000       -1.030675e+01         -1.030675e+01  2.000000e+03       -10.306754       NaN
2021-09-12 09:35:00  97.023753   97.474805  96.515507 -0.022425    1.0         9.995780 -13.485098   971.197854 -0.013695 -0.013695              9.995780  2.000000e+03     -10.306754  1000.000000        2.030253e+01          2.030253e+01 -2.273737e-13         9.995780  0.000000
2021-09-12 09:40:00  98.509870   98.826092  98.089455  0.015317    1.0         9.995780  -6.309279   964.888576 -0.006496 -0.006496              9.995780 -2.273737e-13       9.995780   984.682953       -1.776357e-15         -1.776357e-15 -5.478144e-14         9.995780 -0.015317
2021-09-12 09:45:00  97.160791   97.734126  96.035480 -0.013695    1.0         9.995780  -6.854760   958.033816 -0.007104 -0.007104              9.995780 -5.478144e-14       9.995780   971.197854        0.000000e+00          0.000000e+00 -5.478144e-14         9.995780 -0.013695
2021-09-12 09:50:00  96.529597   97.614306  96.091275 -0.006496   -1.0         9.995780   5.290964   963.324780  0.005523  0.005523             -9.995780 -5.478144e-14       9.995780   964.888576       -1.999156e+01         -1.999156e+01  1.916068e+03        -9.995780 -0.006496
2021-09-12 09:55:00  95.843831   96.087375  95.027100 -0.007104   -1.0        10.106801 -25.859909   937.464871 -0.026844 -0.026844            -10.106801  1.916068e+03      -9.995780   958.033816       -1.110212e-01         -1.110212e-01  1.926650e+03       -10.106801 -0.007104
2021-09-12 10:00:00  95.314512   95.354332  94.124704 -0.005523   -1.0         9.578364  52.504382   989.969253  0.056007  0.056007             -9.578364  1.926650e+03     -10.106801   963.324780        5.284371e-01          5.284371e-01  1.874930e+03        -9.578364  0.005523
2021-09-12 10:05:00  97.873176   99.322519  97.271151  0.026844    1.0        10.714925 -28.580568   961.388686 -0.028870 -0.028870             10.714925  1.874930e+03      -9.578364   937.464871        2.029329e+01          2.029329e+01  0.000000e+00        10.714925 -0.026844
2021-09-12 10:10:00  92.391615   92.528402  91.351452 -0.056007    1.0        10.714925  61.518566  1022.907252  0.063989  0.063989             10.714925  0.000000e+00      10.714925   989.969253        0.000000e+00          0.000000e+00  0.000000e+00        10.714925  0.056007
2021-09-12 10:15:00  89.724255   89.731743  88.892629 -0.028870    1.0        10.714925  15.053359  1037.960611  0.014716  0.014716             10.714925  0.000000e+00      10.714925   961.388686        0.000000e+00          0.000000e+00  0.000000e+00        10.714925 -0.028870
2021-09-12 10:20:00  95.465645   95.770243  95.362905  0.063989   -1.0        10.714925 -21.954992  1016.005618 -0.021152 -0.021152            -10.714925  0.000000e+00      10.714925  1022.907252       -2.142985e+01         -2.142985e+01  2.075921e+03       -10.714925  0.063989
2021-09-12 10:25:00  96.870541   97.266188  95.185577  0.014716    1.0        10.271029 -10.007491  1005.998127 -0.009850 -0.009850             10.271029  2.075921e+03     -10.714925  1037.960611        2.098595e+01          2.098595e+01  0.000000e+00        10.271029  0.014716
2021-09-12 10:30:00  98.919551   99.364340  97.394688  0.021152    1.0        10.271029  13.554595  1019.552722  0.013474  0.013474             10.271029  0.000000e+00      10.271029  1016.005618        0.000000e+00          0.000000e+00  0.000000e+00        10.271029 -0.021152
2021-09-12 10:35:00  97.945210   98.721270  96.748356 -0.009850   -1.0        10.271029   0.992126  1020.544848  0.000973  0.000973            -10.271029  0.000000e+00      10.271029  1005.998127       -2.054206e+01         -2.054206e+01  2.039105e+03       -10.271029 -0.009850
2021-09-12 10:40:00  99.264902   99.740901  99.195169  0.013474   -1.0        10.291038  39.024659  1059.569507  0.038239  0.038239            -10.291038  2.039105e+03     -10.271029  1019.552722       -2.000893e-02         -2.000893e-02  2.041090e+03       -10.291038  0.013474
2021-09-12 10:45:00  99.168307  100.072207  98.473509 -0.000973   -1.0        11.109369  26.472388  1086.041895  0.024984  0.024984            -11.109369  2.041090e+03     -10.291038  1020.544848       -8.183311e-01         -8.183311e-01  2.119139e+03       -11.109369  0.000973
2021-09-12 10:50:00  95.376206   97.474977  94.145798 -0.038239   -1.0        11.678709  14.615079  1100.656973  0.013457  0.013457            -11.678709  2.119139e+03     -11.109369  1059.569507       -5.693396e-01         -5.693396e-01  2.172084e+03       -11.678709  0.038239
2021-09-12 10:55:00  92.993317   94.079530  92.378577 -0.024984    1.0        11.997322  -7.102094  1093.554879 -0.006453 -0.006453             11.997322  2.172084e+03     -11.678709  1086.041895        2.367603e+01          2.367603e+01  0.000000e+00        11.997322  0.024984
2021-09-12 11:00:00  91.741888   92.242182  91.495684 -0.013457   -1.0        11.997322 -17.140366  1076.414513 -0.015674 -0.015674            -11.997322  0.000000e+00      11.997322  1100.656973       -2.399464e+01         -2.399464e+01  2.187110e+03       -11.997322  0.013457
2021-09-12 11:05:00  91.149915   92.151698  90.206595 -0.006453    0.0              NaN        NaN          NaN  0.000000       NaN              0.000000  2.187110e+03     -11.997322  1093.554879        1.199732e+01          1.199732e+01  1.076415e+03         0.000000 -0.006453
2021-09-12 11:10:00  92.578598   93.775690  92.411338  0.015674    0.0              NaN        NaN          NaN  0.000000       NaN                   NaN           NaN            NaN  1076.414513                 NaN                   NaN           NaN              NaN -0.015674
