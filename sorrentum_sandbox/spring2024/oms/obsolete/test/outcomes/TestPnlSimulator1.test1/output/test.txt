df=
                     price  preds     ret_0
2021-09-12 09:30:00    100    1.0       NaN
2021-09-12 09:35:00     90   -1.0 -0.100000
2021-09-12 09:40:00     80    1.0 -0.111111
2021-09-12 09:45:00     90    0.0  0.125000
2021-09-12 09:50:00     70    0.0 -0.222222
df_5mins=
                     price  preds     ret_0
2021-09-12 09:30:00    100    1.0       NaN
2021-09-12 09:35:00     90   -1.0 -0.100000
2021-09-12 09:40:00     80    1.0 -0.111111
2021-09-12 09:45:00     90    0.0  0.125000
2021-09-12 09:50:00     70    0.0 -0.222222
# tot_ret=-0.39506172839506165
After pnl simulation level 1: df_5mins=
                     price  preds     ret_0  sim1.num_shares   sim1.diff  sim1.wealth  sim1.pnl
2021-09-12 09:30:00    100    1.0       NaN        11.111111 -111.111111   888.888889 -0.111111
2021-09-12 09:35:00     90   -1.0 -0.100000        11.111111 -111.111111   777.777778 -0.125000
2021-09-12 09:40:00     80    1.0 -0.111111         8.641975 -172.839506   604.938272 -0.222222
2021-09-12 09:45:00     90    0.0  0.125000              NaN         NaN          NaN  0.000000
2021-09-12 09:50:00     70    0.0 -0.222222              NaN         NaN          NaN  0.000000
After pnl lag computation: df_5mins=
                     price  preds     ret_0  sim1.num_shares   sim1.diff  sim1.wealth  sim1.pnl   lag.pnl
2021-09-12 09:30:00    100    1.0       NaN        11.111111 -111.111111   888.888889 -0.111111 -0.111111
2021-09-12 09:35:00     90   -1.0 -0.100000        11.111111 -111.111111   777.777778 -0.125000 -0.125000
2021-09-12 09:40:00     80    1.0 -0.111111         8.641975 -172.839506   604.938272 -0.222222 -0.222222
2021-09-12 09:45:00     90    0.0  0.125000              NaN         NaN          NaN  0.000000       NaN
2021-09-12 09:50:00     70    0.0 -0.222222              NaN         NaN          NaN  0.000000       NaN
# tot_ret_lag=-0.3950617283950618
After pnl simulation level 2: df_5mins=
                     price  preds     ret_0  sim1.num_shares   sim1.diff  sim1.wealth  sim1.pnl   lag.pnl  sim2.target_n_shares     sim2.cash  sim2.holdings  sim2.wealth  sim2.diff_n_shares  sim2.filled_n_shares   sim2.cash+1  sim2.holdings+1  sim2.pnl
2021-09-12 09:30:00    100    1.0       NaN        11.111111 -111.111111   888.888889 -0.111111 -0.111111             11.111111  1.000000e+03       0.000000  1000.000000           11.111111             11.111111  0.000000e+00        11.111111       NaN
2021-09-12 09:35:00     90   -1.0 -0.100000        11.111111 -111.111111   777.777778 -0.125000 -0.125000            -11.111111  0.000000e+00      11.111111  1000.000000          -22.222222            -22.222222  1.777778e+03       -11.111111  0.000000
2021-09-12 09:40:00     80    1.0 -0.111111         8.641975 -172.839506   604.938272 -0.222222 -0.222222              8.641975  1.777778e+03     -11.111111   888.888889           19.753086             19.753086 -2.273737e-13         8.641975 -0.111111
2021-09-12 09:45:00     90    0.0  0.125000              NaN         NaN          NaN  0.000000       NaN              0.000000 -2.273737e-13       8.641975   777.777778           -8.641975             -8.641975  6.049383e+02         0.000000 -0.125000
2021-09-12 09:50:00     70    0.0 -0.222222              NaN         NaN          NaN  0.000000       NaN                   NaN           NaN            NaN   604.938272                 NaN                   NaN           NaN              NaN -0.222222
